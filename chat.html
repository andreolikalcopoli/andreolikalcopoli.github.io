<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css?family=Poppins"
      rel="stylesheet"
    />
    <title>Chat</title>
  </head>
  <body>
    <!-- <a download="https://static.nationalgeographic.rs/Picture/31394/jpeg/mesec_snimljen_1_540822360" target="_blank">aaa</a> -->
    <!-- <iframe id="my_iframe" style="display:none;"></iframe> -->
    <div id="pinnedPopup">
      <p id="pinnedMsgText">Pinned messages</p>
      <div id="closePinned">X</div>
      <div id="pinnedContainer">
        <div id="onePin">
          <div id="pinMyMsg"><p class="poruka" id="pinMyMsgP"></p></div>
          <div id="pinNotMyMsg"><p class="poruka" id="pinNotMyMsgP"></p></div>
        </div>
      </div>
    </div>
    <div id="blockPopup">
      <p id="blockText">Are you sure you want to block this user?</p>
      <div id="btnsView">
        <div class="yesNo" id="blockYes">YES</div>
        <div class="yesNo" id="blockNo">NO</div>
      </div>
    </div>
    <div id="wholeContend">
      <div id="topContent">
        <div id="logo">
          <div id="logoImg"></div>
        </div>
        <div id="header">BionixMe</div>
        <div id="pinnedMsg">PINNED</div>
        <div id="Login">CHAT</div>
      </div>
      <div id="botContent">
        <div id="botContainer">
          <div id="topBot">
            <div id="name"></div>
            <div id="searchView">
              <input placeholder="Search message" id="searchInput"></input>
            </div>
            <div id="blockBtnView">
              <div id="blockBtn">BLOCK</div>
            </div>
            <div id="pinBtnView">
              <div id="pinBtn">PIN</div>
            </div>
          </div>
          <div id="midBot">
            <div id="myMsg"><p class="poruka" id="myMsgP"></p></div>
            <div id="notMyMsg"><p class="poruka" id="notMyMsgP"></p></div>
            <img class="imageMsg" id="myImageMsg">
            <img class="imageMsg" id="notMyImageMsg">
          </div>
          <div id="botBot">
            <input id="writeMessage" placeholder="Write a message..." />
            <input id="fileInput" type="file">
            <div id="postBtn">POST</div>
          </div>
        </div>
      </div>
    </div>
    <style>
      #postBtn{
        cursor: pointer;
      }
      body {
        margin: 0;
        font-family: "Poppins";
      }
      #closePinned{
        position: absolute;
        top: 10;
        right: 10;
        font-size: 1.2em;
        cursor: pointer;
      }
      #pinnedPopup{
        position: absolute;
        margin-left: 15%;
        margin-top: 10%;
        width: 1000px;
        height: 500px;
        background-color: #4c9dfb;
        border-radius: 10px;
        color: white;
        /* opacity: 0;
         */
         display: none;
        text-align: center;
      }
      #pinnedMsgText{
        font-family: "Poppins";
        font-weight: bold;
        font-size: 1.5em;
      }
      #pinnedContainer{
        height: 70%;
        width: 90%;
        background-color: white;
        border-radius: 5px;
        margin-left: 5%;
        margin-top: 5%;
        overflow-y: scroll;
      }
      #blockPopup{
        position: absolute;
        margin-left: 35%;
        margin-top: 17%;
        width: 500px;
        height: 200px;
        background-color: red;
        border-radius: 10px;
        color: white;
        opacity: 0;
        text-align: center;
      }
      #blockText{
        margin-top: 50px;
      }
      #btnsView{
        display: flex;
      }
      .yesNo{
        flex:1;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid white;
        border-radius: 5px;
        font-family: "Poppins";
        font-weight: bold;
        margin: 30px;
        cursor: pointer;
      }
      .yesNo:hover{
        background-color: white;
        color: red;
      }
      #topContent {
        width: 100%;
        height: 15%;
        display: flex;
        color: #4c9dfb;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 1.5em;
        background-color: #f6f6f6;
      }
      #logo {
        flex: 1;
      }
      #logoImg {
        background: url(https://firebasestorage.googleapis.com/v0/b/app-healthdata.appspot.com/o/chat%2FpTUoCvJtLufZqFRRkmnkiJeVHgn1%2Fimages%2F-MwugugFrbFXar6tYnXL%2Fimage.jpg?alt=media&token=3aefd340-7478-4e35-b966-4dd82ee69f1d);
        width: 50px;
        height: 50px;
        margin-left: 25px;
        background-size: cover;
      }
      #header {
        flex: 10;
      }
      #pinnedMsg{
        flex:1;
        margin: 20px;
        cursor: pointer;
      }
      #login {
        flex: 1;
      }
      #botContent {
        width: 100%;
        height: 85%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #botContainer {
        width: 95%;
        height: 95%;
        display: flex;
        flex-direction: column;
      }
      #topBot {
        flex: 1;
        border-bottom: 3px solid #c4c4c4;
        display: flex;
      }
      #name {
        flex: 7;
        color: #4c9dfb;
        font-family: "Poppins";
        font-weight: bold;
        font-size: 1.7em;
        margin-top: 30px;
        margin-left: 30px;
      }
      #blockBtnView{
        flex:1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
      }
      #blockBtn{
        background-color: white;
        color: red;
        border: 1px solid red;
        width: 100px;
        height: 50px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "Poppins";
        font-weight: bold;
        font-size: 1.2em;
      }
      #blockBtn:hover{
        background-color: red;
        color: white;
      }
      #pinBtnView{
        flex:1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
      }
      #pinBtn{
        background-color: white;
        color: #4c9dfb;
        border: 1px solid #4c9dfb;
        width: 100px;
        height: 50px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "Poppins";
        font-weight: bold;
        font-size: 1.2em;
      }
      #pinBtn:hover{
        background-color: #4c9dfb;
        color: white;
      }
      #midBot {
        flex: 5;
        overflow-y: scroll;
      }
      #myMsg {
        min-height: 5%;
        display: none;
        justify-content: flex-end;
        /* padding: 5px; */
        font-family: "Poppins";
        color: white;
        margin-top: 10px;
        font-size: 0.9em;
        border-radius: 5px;
      }
      .imageMsg{
        cursor: pointer;
        /* display: block !important; */
      }
      #myImageMsg{
        display: flex;
        margin-left: 90%;
        /* background: url("images/logo.png"); */
        border-radius: 5px;
        width: 100px;
        height: 100px;
        display: none;
      }
      #notMyImageMsg{
        display: flex;
        /* background: url("images/logo.png"); */
        border-radius: 5px;
        width: 100px;
        height: 100px;
        display: none;
      }
      #pinMyMsg{
        min-height: 5%;
        display: none;
        justify-content: flex-end;
        /* padding: 5px; */
        font-family: "Poppins";
        color: white;
        margin-top: 10px;
        font-size: 0.9em;
        border-radius: 5px;
      }
      #pinMyMsgP{
        background-color: #4c9dfb;
        padding: 14px;
        border-radius: 5px;
        cursor: pointer;
      }
      #myMsgP {
        background-color: #4c9dfb;
        padding: 14px;
        border-radius: 5px;
        cursor: pointer;
      }
      #notMyMsg {
        min-height: 5%;
        display: none;
        /* padding: 5px; */
        font-family: "Poppins";
        color: #4c9dfb;
        margin-top: 10px;
        font-size: 0.9em;
        border-radius: 5px;
      }
      #pinNotMyMsg{
        min-height: 5%;
        display: none;
        /* padding: 5px; */
        font-family: "Poppins";
        color: #4c9dfb;
        margin-top: 10px;
        font-size: 0.9em;
        border-radius: 5px;
      }
      #pinNotMyMsgP{
        background-color: #f6f6f6;
        padding: 14px;
        border-radius: 5px;
        cursor: pointer;
      }
      #notMyMsgP {
        background-color: #f6f6f6;
        padding: 14px;
        border-radius: 5px;
        cursor: pointer;
      }
      p {
        margin: 10px;
      }
      #searchView{
        flex: 3;
        display: flex;
        /* justify-content: start; */
        align-items: center;
        justify-content: flex-end;
      }
      #searchInput{
        width: 80%;
        margin-right: 20px;
        height: 75%;
        border-radius: 5px;
        border: none;
        background-color: #f6f6f6;
        padding: 10px;
        font-family: "Poppins";
        outline: none;
        color: #4c9dfb;
      }
      #botBot {
        flex: 1;
        display: flex;
      }
      #writeMessage {
        flex: 1;
        background-color: #f6f6f6;
        outline: none;
        border: none;
        padding-left: 30px;
        color: rgba(76, 157, 251, 0.7);
        font-family: "Poppins";
        font-weight: bold;
        font-size: 1.3em;
      }
      ::placeholder {
        color: rgba(76, 157, 251, 0.7);
        font-family: "Poppins";
        font-weight: bold;
      }
      .addFlex{
        display: flex !important;
      }
      
    </style>

    <script type="module" >
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-app.js";
      import { getStorage, ref as ref_storage, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-storage.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-auth.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-analytics.js";
      import {
        getDatabase,
        ref as ref_database,
        onValue,
        set,
        push,
        update,
      } from "https://www.gstatic.com/firebasejs/9.4.0/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyBe2ikeK1R0fv9NPloMaLYE3-xc_raIW7o",
        authDomain: "app-healthdata.firebaseapp.com",
        databaseURL: "https://app-healthdata-default-rtdb.firebaseio.com",
        projectId: "app-healthdata",
        storageBucket: "app-healthdata.appspot.com",
        messagingSenderId: "780488983474",
        appId: "1:780488983474:web:0864b3f14ae9e695851aab",
        measurementId: "G-FECQ1GHF4H",
      };
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getDatabase();
      const storage = getStorage();
      var sender;
      var senderName;
      var messages = [];
      var numberOfMessages = 0;
      var dal = false;
      var id;
      var he;
      var hisName;
      var hisToken = "";
      var updatedValue = false;
      function Download(url) {
    document.getElementById('my_iframe').src = url;
};
      $(document).ready(function () {
        id = window.location.href.split("?")[1];
        if(id == localStorage.getItem("myID")){
          console.log("TO SAM JA");
        }
        console.log(id);
        const db = getDatabase();
        const tokenRef = ref_database(db, "infoChat/" + id);
        onValue(tokenRef, (snapshot) => {
          const tokenRefUser = ref_database(db, "users/" + snapshot.child("member0").val());
          onValue(tokenRefUser, (snapshot) =>{
            hisToken = snapshot.child("token").val();
          });
        });
        const refHe = ref_database(db, "infoChat/"+id);
        onValue(refHe, (snapshot) => {
          he = snapshot.child("member0").val();
          const refHisName = ref_database(db, "users/"+he+"/data");
        onValue(refHisName, (snapshot) => {
          document.getElementById("name").innerHTML = snapshot.child("name").val();
        });
          
        });
        
        const starCountRef = ref_database(db, "chat/" + id + "/messages");
        var dal = false;
        var brojac = 0;
        onValue(starCountRef, (snapshot) => {
          // console.log("UPAO SAM OVDE")
          messages = [];
          const data = snapshot.val();
          snapshot.forEach(function (child) {
            // if (child.key != "lastMessage") {
            var msg = new Message(
              child.child("sender").val(),
              child.child("senderName").val(),
              child.child("text").val(),
              child.child("time").val()
            );
            console.log(msg);
            messages.push(msg);
            // console.log(messages);
            // } else {
            //   sender = child.child("sender").val();
            //   senderName = child.child("senderName").val();
            // }
          });
          // console.log("TU");
          var ifAdd = false;
          if (dal) {
              if(messages[messages.length - 1].text.startsWith("/chat/")){

              if(messages[messages.length - 1].sender == localStorage.getItem("myID")){
                var div = document.getElementById("myImageMsg"),
                clone = div.cloneNode(true);
              }else{
                var div = document.getElementById("notMyImageMsg"),
                clone = div.cloneNode(true);
              }
                // clone.setAttribute("src", "images/"+fajlIme);
                clone.style.display = "block";
                if(brojac%2!=0){
                  document.getElementById("midBot").appendChild(clone);
                }
                  brojac++;
              var tekstRef = messages[messages.length-1].text;
              setTimeout(
              function() {
                console.log(clone);
                const starsRef = ref_storage(storage, tekstRef);
                getDownloadURL(starsRef)
              .then((url) => {
                if(url.includes(".png") || url.includes(".jpg") || url.includes(".jpeg") || url.includes(".svg")){
                clone.setAttribute('src', url);
                clone.setAttribute('link', "a");
                }else{
                  clone.setAttribute('link', url);
                  clone.setAttribute('src', "images/file.svg");
                }
                counter++;
              })
              
              .catch((error) => {
              });
              },2000);
              // brojac = 0;
            }else{
            if (messages[messages.length - 1].senderName == localStorage.getItem("name")) {
              var div = document.getElementById("myMsg"),
                clone = div.cloneNode(true);
              clone.children[0].innerHTML = messages[messages.length - 1].text;
              clone.children[0].setAttribute("time", messages[messages.length - 1].time);
            } else {
              var div = document.getElementById("notMyMsg"),
                clone = div.cloneNode(true);
                // console.log(messages[messages.length - 1]);
              clone.children[0].innerHTML = messages[messages.length - 1].text;
              clone.children[0].setAttribute("time", messages[messages.length - 1].time);
            }
            clone.children[0].setAttribute("time", "AAAA");
            clone.classList.add("addFlex");
            document.getElementById("midBot").appendChild(clone);
          }
          }
          dal = true;
          
          // numberOfMessages = messages.length;
        });
          setTimeout(sortMessages, 2000);
      });
      function writeMessage(text, time, sender, senderName) {
        console.log("POZVAO SAM SE I TEKST JE ");
        console.log(text);
        var db = getDatabase();
        if(id != localStorage.getItem("myID")){
          if(ifPost){
        var p = push(ref_database(db, "chat/" + id + "/messages"), {
          replyText: "",
          sender: sender,
          senderName: senderName,
          text: text+"/"+fajlIme,
          time: time,
        });
        update(ref_database(db, "chat/" + id + "/messages/"+p.key), {
          replyText: "",
          sender: sender,
          senderName: senderName,
          text: text+p.key+"/"+fajlIme,
          time: time,
        });
        
        }else{
          var p = push(ref_database(db, "chat/" + id + "/messages"), {
          replyText: "",
          sender: sender,
          senderName: senderName,
          text: text,
          time: time,
        });
        }
        update(ref_database(db, "infoChat/"+ id),{
          lastMessageText: text,
          lastMsgTime: time,
        })
        if(ifPost){
          var storageRef;
          if(ifImage){
            storageRef = ref_storage(storage, 'chat/'+id+"/images/"+p.key+"/"+fajlIme);
          }else{
            storageRef = ref_storage(storage, 'chat/'+id+"/attachments/"+p.key+"/"+fajlIme);
          }
          uploadBytes(storageRef, fajl).then((snapshot) => {
                console.log('Uploaded a blob or file!');
                // alert("Icon changed!");
                });
        }
        ifPost = false;
        var title = localStorage.getItem("name") + " has sent you a message"
        let body = {
            to: hisToken,
            notification:{
                title: title,
                body: text,
            }
            }
        let options={
            method: "POST",
            headers: new Headers({
                Authorization: "key=AAAAtbjEw7I:APA91bE9kRWHE_l0XtJcDDtcoovMHOa9LD51pau6KUTUU59ArVTJYMggfsNPcJbv1CkCEgjqh7D2lHwP_Q-brJ3Gv_EC7YcVflQo4fZ41mnr8i8VlBcCmrTqMkXrJtywDU7fMu-rZJsd",
                "Content-Type":"application/json"
            }),
            body: JSON.stringify(body)
        }
        fetch("https://fcm.googleapis.com/fcm/send", options).then(res=>{
            console.log(res);
            console.log("SENT");
        }).catch(e=> console.log(e));
      }else{
        // console.log("AAAAAAAA");
      }
        document.getElementById("writeMessage").value = "";
        document.getElementById("midBot").scrollTop =
          document.getElementById("midBot").scrollHeight;
      }
      var fajl;
      var fajlIme;
      var ifImage = false;
      function getExtension(filename) {
  var parts = filename.split('.');
  return parts[parts.length - 1];
}
      document
          .querySelector('input[type="file"]')
          .addEventListener("change", function () {
            ifImage = false;
            if (this.files && this.files[0]) {
              // var img = document.querySelector("img");
              // img.onload = () => {
                // image = this.files[0];
                fajl = this.files[0];
                fajlIme = fajl.name;
                if(getExtension(fajl.name) == "png" || getExtension(fajl.name) == "svg" || getExtension(fajl.name) == "jpg" || getExtension(fajl.name) == "jpeg"){
                  ifImage = true;
                }
              // };
              // img.src = URL.createObjectURL(this.files[0]); // set src to blob url
              
            }
          });
          var ifPost = false;
          $("#postBtn").click(function () {
            ifPost = true;
            var d = new Date();
            var day = d.getDate();
            var month = d.getMonth() + 1;
            var year = d.getFullYear();
            var hour = d.getHours();
            var min = d.getMinutes();
            var seconds = d.getSeconds();
            var final = day + "/" + month + "/" + year + " " + hour + ":" + min + ":" + seconds;
            var storageRef;
            if(ifImage){
              console.log(ifImage);
              console.log("OVO JE IF IMAGE");
              writeMessage("/chat/"+id+"/images/",final,localStorage.getItem('myID'),localStorage.getItem('name'));
              // storageRef = ref_storage(storage, 'chat/'+id+"/images/"+"aaa");
            }else{
              writeMessage("/chat/"+id+"/attachments/",final,localStorage.getItem('myID'),localStorage.getItem('name'));
             
            }
            
              
        })

      var input = document.getElementById("searchInput");
      input.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
          event.preventDefault();
          var search = document.getElementById("searchInput").value;
          var countDiv = document.getElementById("midBot");
          for(var i = 0; i < countDiv.childElementCount - 4;i++){
            // console.log(countDiv.children[i+4].children[0].innerHTML);
            if(countDiv.children[i+4].children[0].innerHTML == search){
              // console.log(search);
              var myDiv = document.getElementById("midBot");
              var topPos = countDiv.children[i+4].offsetTop;
              // console.log(topPos);
              var off = countDiv.children[4].offsetTop;
              myDiv.scrollTop = topPos - off;
            }
          }
        }
      });
      var input = document.getElementById("writeMessage");
      input.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
          event.preventDefault();
          if (input.value != "") {
            var d = new Date();
            var day = d.getDate();
            var month = d.getMonth() + 1;
            var year = d.getFullYear();
            var hour = d.getHours();
            var min = d.getMinutes();
            var seconds = d.getSeconds();
            var final = day + "/" + month + "/" + year + " " + hour + ":" + min + ":" + seconds;
            // console.log(localStorage.getItem('myID')); 
            // console.log(localStorage.getItem('name')); 
            writeMessage(input.value, final, localStorage.getItem('myID'), localStorage.getItem('name'));
          }
        }
      });

      $(document).on("click", "#pinnedMsg", function(){
        document.getElementById("pinnedPopup").style.display = "unset";
        pinnedPressed();
      });
      $(document).on("click", "#closePinned", function(){
        document.getElementById("pinnedPopup").style.display = "none";
      });

      $(document).on("click", "#blockBtn", function(){
        document.getElementById("blockPopup").style.opacity = 1;
      });
      $(document).on("click", "#blockNo", function(){
        document.getElementById("blockPopup").style.opacity = 0;
      });
      $(document).on("click", "#blockYes", function(){
        var db = getDatabase();
        // console.log(he);
        push(ref_database(db, "doctors/" + localStorage.getItem("myID") + "/blocked"), {
          id: he,
        });
        alert("User blocked!");
        window.location = "inbox.html?" + localStorage.getItem("myID");
      });

      var pinBool = false;
      $(document).on("click", "#pinBtn", function(){
        if(pinBool){
          this.style.backgroundColor = "white";
          this.style.color = "#4c9dfb";
        }else{
          this.style.backgroundColor = "#4c9dfb";
          this.style.color = "white";
        }
        pinBool = !pinBool;
      });
      $(document).on("click", ".poruka", function(){
        if(pinBool){
          var p = push(ref_database(db, "chat/" + id + "/pinnedMessages/" + id), {
            chatID: id,
            username: localStorage.getItem("name"),
          });
          var sender = this.getAttribute("id");
          if(sender == "myMsgP"){
            set(ref_database(db, "chat/" + id + "/pinnedMessages/" + id + "/" + p.key + "/chatMessage"),{
              sender: localStorage.getItem("myID"),
              senderName: localStorage.getItem("name"),
              text: this.innerHTML,
              time: this.getAttribute("time")
            })
          }else{
            set(ref_database(db, "chat/" + id + "/pinnedMessages/" + id + "/" + p.key + "/chatMessage"),{
              sender: localStorage.getItem("myID"),
              senderName: document.getElementById("name").innerHTML,
              text: this.innerHTML,
              time: this.getAttribute("time")
            })
          }
          
          alert("Message saved!");

        }
      });

      function sortMessages() {
        // console.log("USO SAM DA SORTIRAM");
        // for (var i = 0; i < messages.length; i++) {
        //   //set min to the current iteration of i
        //   var min = i;
        //   for (var j = i + 1; j < messages.length; j++) {
        //     if (!newDate(messages[i].time, messages[j].time)) {
        //       min = j;
        //     }
        //   }
        //   var temp = messages[i];
        //   messages[i] = messages[min];
        //   messages[min] = temp;
        // }
        // messages.reverse();
        // console.log(messages);
        var counter = 0;
        for (var i = 0; i < messages.length; i++) {
          if(messages[i].text.startsWith("/chat/")){
            console.log(messages[i].text);
              const starsRef = ref_storage(storage, messages[i].text);
              if(messages[i].sender == localStorage.getItem("myID")){
                var div = document.getElementById("myImageMsg"),
                clone = div.cloneNode(true);
              }else{
                var div = document.getElementById("notMyImageMsg"),
                clone = div.cloneNode(true);
              }
              
                clone.style.display = "block";
                document.getElementById("midBot").appendChild(clone);
              if(messages[i].sender == localStorage.getItem("myID")){
                getDownloadURL(starsRef)
              .then((url) => {
                const collection = document.getElementsByClassName("imageMsg");
                // console.log(collection);
                // console.log("USO");
                if(url.includes(".png") || url.includes(".jpg") || url.includes(".jpeg") || url.includes(".svg")){
                collection[counter + 2].setAttribute('src', url);
                collection[counter + 2].setAttribute('link', "a");
                }else{
                  collection[counter + 2].setAttribute('link', url);
                  collection[counter + 2].setAttribute('src', "images/file.svg");
                }
                counter++;
                
              })
              .catch((error) => {
              });

              }else{
                getDownloadURL(starsRef)
              .then((url) => {
                const collection = document.getElementsByClassName("imageMsg");
                // console.log(collection);
                // console.log("USO");
                if(url.includes(".png") || url.includes(".jpg") || url.includes(".jpeg") || url.includes(".svg")){
                collection[counter + 2].setAttribute('src', url);
                collection[counter + 2].setAttribute('link', "a");
                }else{
                  collection[counter + 2].setAttribute('download', url);
                  collection[counter + 2].setAttribute('src', "images/file.svg");
                }
                counter++;
              })
              .catch((error) => {
              });
              }
              
            }else{
              console.log(messages[i].text);
          if (messages[i].sender == localStorage.getItem("myID")) {
            var div = document.getElementById("myMsg"),
              clone = div.cloneNode(true);
            clone.children[0].innerHTML = messages[i].text;
          } else {
            var div = document.getElementById("notMyMsg"),
              clone = div.cloneNode(true);
            clone.children[0].innerHTML = messages[i].text;
          }
          clone.classList.add("addFlex");
          document.getElementById("midBot").appendChild(clone);
            }
        }
        // document.getElementById("midBot").firstElementChild.remove();
        // document.getElementById("midBot").firstElementChild.remove();
        document.getElementById("midBot").scrollTop =
          document.getElementById("midBot").scrollHeight;
        // console.log(messages);
      }
      
      function downloadURI(uri, name) {
    let link = document.createElement("a");
    link.download = name;
    link.href = uri;
    link.target = "_blank";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
      $(document).on("click", ".imageMsg", function(){
        downloadURI(this.getAttribute('download'), "aa");
        // browser.downloads.download({url: "https://example.org/image.png"})
        // download(this.getAttribute("download"),"aaa");
        // window.location = this.getAttribute("download");
      });   
      var texts = [];
      var whoSent = [];
      function pinnedPressed(){
        // console.log(id);
        texts = [];
        whoSent = [];
        // for(var i = 0; i < document.getElementById("pinContainer").childElementCount; i++){
        //   document.getElementById("pinnedContainer").firstElementChild.remove();
        // }
        const starCountRef = ref_database(db, "chat/" + id + "/pinnedMessages");
        onValue(starCountRef, (snapshot) => {
          console.log(snapshot.val());
          snapshot.forEach(function (child) {
            child.forEach(function (part) {
              part.forEach(function (partic){
                var text = "";
                if(partic.key == "chatMessage"){
                  text = partic.child("text").val();
                  texts.push(text);
                  whoSent.push(partic.child("senderName").val());
                }
                // if(partic.key == "username"){
                //   if(partic.val() == localStorage.getItem("name")){
                //     console.log(text);
                //     texts.push(text);
                //   }
                // }
              });
            });
          });
        });
        showMessagesPin();
      }
      function showMessagesPin() {
        setTimeout(
          function() {
            // console.log(texts);
            // console.log(whoSent);
            for(var i = 0; i < texts.length; i++){
              if(whoSent[i] == localStorage.getItem("name")){
                var div = document.getElementById("pinMyMsg"),
                clone = div.cloneNode(true);
                // console.log(clone);
                clone.children[0].innerHTML = texts[i];
              }else{
                var div = document.getElementById("pinNotMyMsg"),
                clone = div.cloneNode(true);
                // console.log(clone);
                clone.children[0].innerHTML = texts[i];
              }
              // console.log("PIN JE");
              // console.log(whoSent[i]);
              clone.classList.add("addFlex");
              document.getElementById("pinnedContainer").appendChild(clone);
            }
            document.getElementById("pinnedContainer").firstElementChild.remove();
            // document.getElementById("pinnedContainer").firstElementChild.remove();
          }, 2000);
        }

      function newDate(date1, date2) {
        var first2 = date1.split(" ");
        var second2 = date2.split(" ");
        var first3 = first2[0].split("/");
        var second3 = second2[0].split("/");
        var first22 = first2[1].split(":");
        var second22 = second2[1].split(":");
        if (first3[2] > second3[2]) {
          return true;
        } else if (first3[2] < second3[2]) {
          return false;
        } else {
          if (first3[1] > second3[1]) {
            return true;
          } else if (first3[1] < second3[1]) {
            return false;
          } else {
            if (first3[0] > second3[0]) {
              return true;
            } else if (first3[0] < second3[0]) {
              return false;
            } else {
              if (first22[0] > second22[0]) {
                return true;
              } else if (first22[0] < second22[0]) {
                return false;
              } else {
                if (first22[1] > second22[1]) {
                  return true;
                } else if (first22[1] < second22[1]) {
                  return false;
                } else {
                  if(first22[2]>second22[2]){
                    return true;
                  }else{
                    return false;
                  }
                }
              }
            }
          }
        }
      }
      class Message {
        constructor(sender, senderName, text, time) {
          this.sender = sender;
          this.senderName = senderName;
          this.text = text;
          this.time = time;
        }
      }
    </script>
  </body>
</html>
